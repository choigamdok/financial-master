<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì€í‡´ ì¸ì¶œ ì„¤ê³„ ë³´ê³ ì„œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @page {
            size: A4;
            margin: 20mm;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: white;
            color: #1f2937;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .no-print {
                display: none !important;
            }

            .page-break {
                page-break-after: always;
            }

            .avoid-break {
                page-break-inside: avoid;
            }
        }

        .report-header {
            border-bottom: 4px solid #9333ea;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }

        .report-section {
            margin-bottom: 2rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: right;
        }

        .data-table th:first-child,
        .data-table td:first-child {
            text-align: center;
        }

        .data-table th.text-left,
        .data-table td.text-left {
            text-align: left;
        }

        .data-table th {
            background-color: #faf5ff;
            font-weight: 600;
            white-space: nowrap;
        }

        .highlight-box {
            background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }
    </style>
</head>

<body class="p-8 max-w-4xl mx-auto">
    <!-- í”„ë¦°íŠ¸ ë²„íŠ¼ -->
    <div class="no-print mb-6 text-right">
        <button onclick="window.print()"
            class="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-purple-700 transition">
            ğŸ–¨ï¸ ì¸ì‡„ / PDF ì €ì¥
        </button>
    </div>

    <!-- í—¤ë” -->
    <div class="report-header">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-black text-gray-900 mb-2">ì€í‡´ ì¸ì¶œ ì„¤ê³„ ë³´ê³ ì„œ</h1>
                <p class="text-sm text-gray-500">Retirement Withdrawal Plan Report</p>
            </div>
            <div class="text-right text-sm text-gray-600">
                <p id="report-date"></p>
                <p class="font-bold text-purple-600 mt-1">ì¬ë¬´ì„¤ê³„ ë§ˆìŠ¤í„°</p>
            </div>
        </div>
    </div>

    <!-- ê³ ê° ì •ë³´ -->
    <div class="report-section">
        <h2 class="text-xl font-bold text-gray-900 mb-4 pb-2 border-b-2 border-gray-200">ğŸ“‹ ê³ ê° ì •ë³´</h2>
        <table class="data-table">
            <tr>
                <th class="w-1/4 text-center">ê³ ê°ëª…</th>
                <td id="client-name" class="text-left"></td>
                <th class="w-1/4 text-center">í˜„ì¬ ë‚˜ì´</th>
                <td id="client-age" class="text-left"></td>
            </tr>
            <tr>
                <th class="text-center">ë¶„ì„ ëª©ì </th>
                <td colspan="3" class="text-left"><span id="analysis-purpose"></span></td>
            </tr>
        </table>
    </div>

    <!-- ì€í‡´ ì†Œë“ ìš”ì•½ -->
    <div class="report-section">
        <h2 class="text-xl font-bold text-gray-900 mb-4 pb-2 border-b-2 border-gray-200">ğŸ’ ì€í‡´ ì†Œë“ ìš”ì•½ (65ì„¸ ê¸°ì¤€)</h2>
        <div class="grid grid-cols-2 gap-6">
            <div class="bg-blue-50 p-6 rounded-lg text-center border border-blue-100">
                <p class="text-sm text-blue-800 mb-2 font-bold">ì›” ì˜ˆìƒ ìˆ˜ë ¹ì•¡ (ëª…ëª© ê°€ì¹˜)</p>
                <p class="text-4xl font-black text-blue-600" id="summary-nominal"></p>
            </div>
            <div class="bg-purple-50 p-6 rounded-lg text-center border border-purple-100">
                <p class="text-sm text-purple-800 mb-2 font-bold">ì›” ì˜ˆìƒ ìˆ˜ë ¹ì•¡ (í˜„ì¬ ê°€ì¹˜)</p>
                <p class="text-3xl font-black text-purple-600" id="summary-pv"></p>
                <p class="text-xs text-gray-500 mt-2">* ë¬¼ê°€ìƒìŠ¹ë¥  2% ë°˜ì˜</p>
            </div>
        </div>
    </div>

    <!-- ì¤€ë¹„ëœ ì€í‡´ ìê¸ˆ ëª©ë¡ -->
    <div class="report-section">
        <h2 class="text-xl font-bold text-gray-900 mb-4 pb-2 border-b-2 border-gray-200">ğŸ’° ì¤€ë¹„ëœ ì€í‡´ ìê¸ˆ</h2>
        <table class="data-table text-sm">
            <thead>
                <tr>
                    <th class="text-center">ìê¸ˆëª…</th>
                    <th class="text-center">ìˆ˜ë ¹ ê¸°ê°„</th>
                    <th class="text-right">ì›” ìˆ˜ë ¹ì•¡ (í˜„ì¬ ê¸°ì¤€)</th>
                </tr>
            </thead>
            <tbody id="funds-list">
                <!-- JS ë¡œ ìƒì„± -->
            </tbody>
        </table>
    </div>

    <!-- ì—°ë„ë³„ ìˆ˜ë ¹ì•¡ ì°¨íŠ¸ -->
    <div class="report-section avoid-break">
        <h2 class="text-xl font-bold text-gray-900 mb-4 pb-2 border-b-2 border-gray-200">ğŸ“Š ì—°ë ¹ë³„ ì›” ìˆ˜ë ¹ì•¡ ì¶”ì´</h2>
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200" style="height: 350px;">
            <canvas id="withdrawalChart"></canvas>
        </div>
    </div>

    <!-- ìƒì„¸ ìˆ˜ë ¹ ê³„íší‘œ -->
    <div class="report-section page-break">
        <h2 class="text-xl font-bold text-gray-900 mb-4 pb-2 border-b-2 border-gray-200">ğŸ“‘ ìƒì„¸ ìˆ˜ë ¹ ê³„íší‘œ (ë‹¨ìœ„: ì²œì›)</h2>
        <div class="overflow-x-auto">
            <table class="data-table text-sm">
                <thead class="bg-gray-100 text-gray-600 uppercase font-medium">
                    <tr id="detailTableHeader">
                        <!-- ë™ì  ìƒì„± -->
                    </tr>
                </thead>
                <tbody id="detailTableBody">
                    <!-- ë™ì  ìƒì„± -->
                </tbody>
            </table>
        </div>
        <p class="text-xs text-gray-400 mt-2 text-right">* ëª…ëª©: í•´ë‹¹ ì‹œì ì˜ ê¸ˆì•¡ / ì‹¤ì§ˆ: ë¬¼ê°€ìƒìŠ¹ë¥ (2%)ì„ ë°˜ì˜í•˜ì—¬ í˜„ì¬ ê°€ì¹˜ë¡œ í™˜ì‚°í•œ ê¸ˆì•¡</p>
    </div>

    <!-- ê¶Œì¥ ì‚¬í•­ -->
    <div class="report-section avoid-break">
        <h2 class="text-xl font-bold text-gray-900 mb-4 pb-2 border-b-2 border-gray-200">ğŸ’¡ ì¬ë¬´ ì„¤ê³„ì‚¬ ì¡°ì–¸</h2>
        <div class="bg-purple-50 p-6 rounded-lg border-l-4 border-purple-500">
            <ul class="space-y-2 text-gray-700">
                <li class="flex items-start gap-2">
                    <span class="text-purple-600 font-bold">â€¢</span>
                    <span>ì€í‡´ í›„ ì†Œë“ ì ˆë²½ì„ ë§‰ê¸° ìœ„í•´ êµ­ë¯¼ì—°ê¸ˆ, í‡´ì§ì—°ê¸ˆ, ê°œì¸ì—°ê¸ˆì˜ '3ì¸µ ì—°ê¸ˆ' êµ¬ì¡°ë¥¼ íŠ¼íŠ¼íˆ í•´ì•¼ í•©ë‹ˆë‹¤.</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-purple-600 font-bold">â€¢</span>
                    <span>ë¬¼ê°€ ìƒìŠ¹ìœ¼ë¡œ ì¸í•´ í™”í ê°€ì¹˜ê°€ í•˜ë½í•˜ë¯€ë¡œ, ì‹¤ì§ˆ êµ¬ë§¤ë ¥ì„ ìœ ì§€í•˜ë ¤ë©´ ë¬¼ê°€ ì—°ë™í˜• ìì‚°(êµ­ë¯¼ì—°ê¸ˆ ë“±)ì˜ ë¹„ì¤‘ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-purple-600 font-bold">â€¢</span>
                    <span>íŠ¹ì • ì‹œê¸°(ì˜ˆ: 70ëŒ€ ì´ˆë°˜)ì— ì†Œë“ì´ ë¶€ì¡±í•˜ì§€ ì•Šë„ë¡ ì¸ì¶œ ì‹œê¸°ë¥¼ ì „ëµì ìœ¼ë¡œ ë¶„ì‚° ë°°ì¹˜í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- ë©´ì±… ì¡°í•­ -->
    <div class="report-section text-xs text-gray-500 border-t pt-4 mt-8">
        <p class="mb-2">
            <strong>ë©´ì±… ì¡°í•­:</strong> ë³¸ ë³´ê³ ì„œì˜ ë¶„ì„ ê²°ê³¼ëŠ” ì…ë ¥ëœ ê°€ì •ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‹œë®¬ë ˆì´ì…˜ì´ë©°, ì‹¤ì œ íˆ¬ì ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            íˆ¬ì ê²°ì • ì‹œì—ëŠ” ì‹œì¥ ìƒí™©, ê°œì¸ì˜ ì¬ë¬´ ìƒíƒœ, ë¦¬ìŠ¤í¬ ì„±í–¥ ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
        </p>
        <p class="text-center mt-4 text-gray-400">
            Â© 2024-2026 ê¸ˆì‡¼ë§˜ì˜ ê¸ˆìœµìŠ¤ì¿¨. All rights reserved.
        </p>
    </div>

    <script>
        // ë‚ ì§œ ì„¤ì •
        document.getElementById('report-date').textContent = new Date().toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // 1. URL íŒŒë¼ë¯¸í„° íŒŒì‹±
        const params = new URLSearchParams(window.location.search);

        let funds = [];
        try {
            const fundsStr = params.get('funds');
            if (fundsStr) {
                funds = JSON.parse(decodeURIComponent(fundsStr));
            }
        } catch (e) {
            console.error('Funds parsing error:', e);
        }

        const reportData = {
            clientName: params.get('clientName') || 'ê³ ê°ëª…',
            clientAge: params.get('clientAge') || '-',
            purpose: params.get('purpose') || 'ì€í‡´ ì¸ì¶œ ì„¤ê³„',
            currentAge: parseInt(params.get('currentAge')) || 50,
            summaryNominal: params.get('summaryNominal') || '0',
            summaryPV: params.get('summaryPV') || '0'
        };

        const formatMoney = (n) => parseInt(n).toLocaleString() + 'ì²œì›';

        // 2. ë°ì´í„° í‘œì‹œ
        document.getElementById('client-name').textContent = reportData.clientName;
        document.getElementById('client-age').textContent = reportData.clientAge + 'ì„¸ (' + reportData.currentAge + 'ì„¸ ê¸°ì¤€ ì„¤ê³„)';
        document.getElementById('analysis-purpose').textContent = reportData.purpose;

        document.getElementById('summary-nominal').textContent = formatMoney(reportData.summaryNominal.replace(/,/g, ''));
        document.getElementById('summary-pv').textContent = formatMoney(reportData.summaryPV.replace(/,/g, ''));

        // 3. ìê¸ˆ ëª©ë¡ í‘œì‹œ
        const fundsListBody = document.getElementById('funds-list');
        funds.filter(f => f.amount > 0).forEach(fund => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-left font-medium">${fund.name}</td>
                <td class="text-center">${fund.startAge}ì„¸ ~ ${fund.endAge}ì„¸</td>
                <td class="text-right">${fund.amount.toLocaleString()}ì²œì›</td>
            `;
            fundsListBody.appendChild(tr);
        });

        // 4. ë°ì´í„° ê³„ì‚°
        const PENSION_GROWTH_RATE = 0.015;
        const INFLATION_RATE = 0.02;

        const minStartAge = Math.min(...funds.map(f => f.startAge));
        const maxEndAge = Math.max(...funds.map(f => f.endAge));
        const displayStartAge = Math.min(reportData.currentAge, minStartAge);
        const displayEndAge = Math.max(90, maxEndAge);

        const chartData = [];
        const labels = [];

        for (let age = displayStartAge; age <= displayEndAge; age++) {
            labels.push(age + 'ì„¸');
            let row = { age, funds: [], totalNominal: 0, totalPV: 0 };

            funds.forEach(fund => {
                let amount = 0;
                if (age >= fund.startAge && age <= fund.endAge) {
                    if (fund.isInflationLinked) {
                        const years = age - fund.startAge;
                        amount = fund.amount * Math.pow(1 + PENSION_GROWTH_RATE, years);
                    } else {
                        amount = fund.amount;
                    }
                }
                row.funds.push(Math.round(amount));
                row.totalNominal += amount;
            });

            const yearsFromNow = age - reportData.currentAge;
            const discount = Math.pow(1 + INFLATION_RATE, Math.max(0, yearsFromNow));
            row.totalPV = Math.round(row.totalNominal / discount);
            row.totalNominal = Math.round(row.totalNominal);

            chartData.push(row);
        }

        // 5. ì°¨íŠ¸ ìƒì„±
        const FUND_COLORS = ['#ef4444', '#facc15', '#22c55e', '#3b82f6', '#ec4899', '#a855f7'];

        const datasets = funds.map((fund, idx) => ({
            label: fund.name,
            data: chartData.map(d => d.funds[idx]),
            backgroundColor: FUND_COLORS[idx % FUND_COLORS.length],
            stack: 'Stack 0',
        }));

        datasets.push({
            type: 'line',
            label: 'í•©ê³„ (ì‹¤ì§ˆ)',
            data: chartData.map(d => d.totalPV),
            borderColor: '#374151',
            borderWidth: 3,
            fill: false,
            tension: 0.3,
            pointRadius: 0
        });

        const ctx = document.getElementById('withdrawalChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: {
                        stacked: true,
                        grid: { borderDash: [4, 4] },
                        ticks: { callback: v => (v / 1000).toFixed(0) + 'ë°±ë§Œ' }
                    }
                },
                plugins: {
                    legend: { position: 'bottom' }, /* ë²”ë¡€ ì•„ë˜ë¡œ */
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                let label = ctx.dataset.label || '';
                                if (label) label += ': ';
                                if (ctx.parsed.y !== null) label += ctx.parsed.y.toLocaleString() + ' ì²œì›';
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // 6. ìƒì„¸ í…Œì´ë¸” ìƒì„±
        const detailTableHeader = document.getElementById('detailTableHeader');
        const detailTableBody = document.getElementById('detailTableBody');

        // Header
        let headerHTML = `<th class="text-center bg-gray-100">ë‚˜ì´</th>`;
        funds.forEach(f => {
            headerHTML += `<th class="text-center whitespace-nowrap">${f.name}</th>`;
        });
        headerHTML += `
            <th class="bg-blue-50 text-blue-900 border-l border-blue-100">í•©ê³„ (ëª…ëª©)</th>
            <th class="bg-red-50 text-red-900">í•©ê³„ (ì‹¤ì§ˆ)</th>
        `;
        detailTableHeader.innerHTML = headerHTML;

        // Body
        detailTableBody.innerHTML = '';
        chartData.forEach(row => {
            const tr = document.createElement('tr');

            let rowHTML = `
                <td class="text-center font-medium bg-gray-50">
                    ${row.age}ì„¸
                </td>
            `;

            row.funds.forEach((amt) => {
                rowHTML += `
                    <td class="${amt > 0 ? '' : 'text-gray-300'}">
                        ${amt > 0 ? amt.toLocaleString() : '-'}
                    </td>
                `;
            });

            rowHTML += `
                <td class="font-bold text-blue-600 bg-blue-50/30 border-l border-blue-100">
                    ${row.totalNominal.toLocaleString()}
                </td>
                <td class="font-bold text-red-600 bg-red-50/30">
                    ${row.totalPV.toLocaleString()}
                </td>
            `;

            tr.innerHTML = rowHTML;
            detailTableBody.appendChild(tr);
        });
    </script>
</body>

</html>