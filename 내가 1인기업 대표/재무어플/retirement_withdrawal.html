<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì€í‡´ í›„ ì›” ìƒí™œë¹„ ì‹œë®¬ë ˆì´í„° (Retirement Withdrawal)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen font-sans">

    <div class="max-w-6xl mx-auto p-4 sm:p-6">

        <!-- Header -->
        <div class="mb-8 text-center sm:text-left">
            <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center justify-center sm:justify-start gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    class="text-blue-600" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                ì€í‡´ í›„ ì›” ìƒí™œë¹„ ì‹œë®¬ë ˆì´í„°
            </h1>
            <p class="text-gray-600">
                ì¤€ë¹„ëœ ì€í‡´ ìê¸ˆì„ ì…ë ¥í•˜ê³  ë‚˜ì´ëŒ€ë³„ ì´ ìˆ˜ë ¹ì•¡ê³¼ ì‹¤ì§ˆ ê°€ì¹˜(ë¬¼ê°€ìƒìŠ¹ë¥  2% ë°˜ì˜)ë¥¼ í™•ì¸í•˜ì„¸ìš”.
            </p>
        </div>

        <!-- Configuration -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

            <!-- Inputs -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            class="text-green-600" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        ìê¸ˆ ì…ë ¥ (ë‹¨ìœ„: ì²œì›)
                    </h2>
                    <div class="flex items-center gap-2 bg-blue-50 px-3 py-1 rounded-lg text-sm text-blue-800">
                        <span class="font-semibold">í˜„ì¬ ë‚˜ì´:</span>
                        <input type="number" id="currentAge" value="50"
                            class="w-16 p-1 border border-blue-200 rounded text-center bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold">
                        <span>ì„¸</span>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-600 uppercase">
                            <tr>
                                <th class="px-3 py-3 rounded-l-lg w-1/3">ì¤€ë¹„ëœ ì€í‡´ìê¸ˆ</th>
                                <th class="px-3 py-3 w-1/6">ìˆ˜ë ¹ ì‹œì‘</th>
                                <th class="px-3 py-3 w-1/6">ìˆ˜ë ¹ ì¢…ë£Œ</th>
                                <th class="px-3 py-3 rounded-r-lg w-1/4">ì›” ìˆ˜ë ¹ì•¡(ì²œì›)</th>
                            </tr>
                        </thead>
                        <tbody id="inputTableBody" class="divide-y divide-gray-100">
                            <!-- JS Generated Rows -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-xs text-gray-500 flex flex-wrap gap-4">
                    <span class="flex items-center gap-1">ğŸ“Œ ë¬¼ê°€ìƒìŠ¹ë¥  ì ìš©: 2% (ì‹¤ì§ˆ ê°€ì¹˜ ê³„ì‚°ìš©)</span>
                    <span class="flex items-center gap-1">ğŸ“ˆ 1ë²ˆ í•­ëª©(êµ­ë¯¼ì—°ê¸ˆ) ìƒìŠ¹ë¥ : 1.5% (ìˆ˜ë ¹ì•¡ ìë™ì¦ì•¡)</span>
                </div>
            </div>

            <!-- Summary Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col justify-center">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ìš”ì•½ (65ì„¸ ê¸°ì¤€)</h3>
                <div class="space-y-6">
                    <div>
                        <p class="text-sm text-gray-500 mb-1">65ì„¸ ì˜ˆìƒ ì›” ìˆ˜ë ¹ì•¡ (ëª…ëª©)</p>
                        <p class="text-4xl font-bold text-blue-600">
                            <span id="summaryNominal">0</span> <span class="text-lg text-gray-500 font-normal">ì²œì›</span>
                        </p>
                    </div>
                    <div class="pt-4 border-t border-gray-100">
                        <p class="text-sm text-gray-500 mb-1">ì‹¤ì§ˆ ê°€ì¹˜ í™˜ì‚° (ë¬¼ê°€ë°˜ì˜)</p>
                        <p class="text-2xl font-bold text-gray-700">
                            <span id="summaryPV">0</span> <span class="text-sm text-gray-500 font-normal">ì²œì›</span>
                        </p>
                        <p class="text-xs text-gray-400 mt-2">
                            * í˜„ì¬ ë‚˜ì´(<span id="labelCurrentAge">50</span>ì„¸)ë¡œë¶€í„° 65ì„¸ê¹Œì§€ ë¬¼ê°€ìƒìŠ¹ë¥  2%ë¡œ í• ì¸í•œ ê°€ì¹˜ì…ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
            <h3 class="text-lg font-semibold mb-6 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    class="text-purple-600" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                ë‚˜ì´ëŒ€ë³„ ì›” ìˆ˜ë ¹ì•¡ ì¶”ì´
            </h3>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- Detail Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    class="text-orange-600" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                ìƒì„¸ ìˆ˜ë ¹ ê³„íší‘œ
            </h3>
            <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                <table class="w-full text-sm text-right border-collapse">
                    <thead class="bg-gray-100 text-gray-600 uppercase font-medium sticky top-0 z-10">
                        <tr id="detailTableHeader">
                            <th class="px-4 py-3 text-center sticky left-0 bg-gray-100 border-r border-gray-200">ë‚˜ì´</th>
                            <!-- Dynamic Headers -->
                            <th class="px-4 py-3 bg-blue-50 text-blue-900 border-l border-blue-100 min-w-[120px]">í•©ê³„
                                (ëª…ëª©)</th>
                            <th class="px-4 py-3 bg-red-50 text-red-900 min-w-[120px]">í•©ê³„ (ì‹¤ì§ˆ)</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody" class="divide-y divide-gray-100">
                        <!-- JS Generated -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-12 mb-4 text-center text-gray-500 text-sm font-medium border-t border-gray-200 pt-6">
            Â© ê¸ˆì‡¼ë§˜ì˜ ê¸ˆìœµìŠ¤ì¿¨ All rights reserved
        </div>
    </div>

    <script>
        // --- Constants & State ---
        const INFLATION_RATE = 0.02;
        const PENSION_GROWTH_RATE = 0.015;

        let state = {
            currentAge: 50,
            funds: [
                { id: 1, name: 'êµ­ë¯¼ì—°ê¸ˆ (ê³µë¬´ì›ì—°ê¸ˆ)', startAge: 65, endAge: 100, amount: 1500, isInflationLinked: true },
                { id: 5, name: 'í‡´ì§ì—°ê¸ˆ (IRP)', startAge: 60, endAge: 70, amount: 1000, isInflationLinked: false },
                { id: 4, name: 'ê°œì¸ì—°ê¸ˆ', startAge: 60, endAge: 80, amount: 500, isInflationLinked: false },
                { id: 2, name: 'ì§ì ‘ ì…ë ¥ 1', startAge: 65, endAge: 75, amount: 0, isInflationLinked: false },
                { id: 3, name: 'ì§ì ‘ ì…ë ¥ 2', startAge: 65, endAge: 75, amount: 0, isInflationLinked: false },
                { id: 6, name: 'ì§ì ‘ ì…ë ¥ 3', startAge: 65, endAge: 75, amount: 0, isInflationLinked: false },
            ]
        };

        const FUND_COLORS = ['#ef4444', '#facc15', '#22c55e', '#3b82f6', '#ec4899', '#a855f7'];

        // --- DOM Elements ---
        const els = {
            currentAge: document.getElementById('currentAge'),
            labelCurrentAge: document.getElementById('labelCurrentAge'),
            inputTableBody: document.getElementById('inputTableBody'),
            summaryNominal: document.getElementById('summaryNominal'),
            summaryPV: document.getElementById('summaryPV'),
            detailTableHeader: document.getElementById('detailTableHeader'),
            detailTableBody: document.getElementById('detailTableBody'),
            canvas: document.getElementById('mainChart')
        };

        let chartInstance = null;

        // --- Init ---
        function init() {
            renderInputTable();
            els.currentAge.addEventListener('input', (e) => {
                state.currentAge = Number(e.target.value);
                els.labelCurrentAge.textContent = state.currentAge;
                calculateAndRender();
            });
            calculateAndRender();
        }

        // --- Inputs Rendering ---
        function renderInputTable() {
            els.inputTableBody.innerHTML = '';
            state.funds.forEach((fund, idx) => {
                const tr = document.createElement('tr');
                tr.className = `group hover:bg-gray-50 transition-colors ${idx === 0 ? 'bg-blue-50/50' : ''}`;

                tr.innerHTML = `
                    <td class="px-3 py-2">
                        <div class="flex flex-col">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${FUND_COLORS[idx]}"></div>
                                <input type="text" data-id="${fund.id}" data-field="name" value="${fund.name}" 
                                    class="bg-transparent border-b border-transparent focus:border-blue-500 outline-none font-medium w-full text-gray-900 input-field" placeholder="ìê¸ˆëª… ì…ë ¥">
                            </div>
                            ${idx === 0 ? '<span class="text-xs text-blue-600 flex items-center gap-1 mt-1 pl-5"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg> ë§¤ë…„ 1.5% ì¦ì•¡</span>' : ''}
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <div class="flex items-center gap-1">
                            <input type="number" data-id="${fund.id}" data-field="startAge" value="${fund.startAge}" 
                                class="w-full bg-white border border-gray-200 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 outline-none text-center input-field">
                            <span class="text-gray-400 text-xs">ì„¸</span>
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <div class="flex items-center gap-1">
                            <input type="number" data-id="${fund.id}" data-field="endAge" value="${fund.endAge}" 
                                class="w-full bg-white border border-gray-200 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 outline-none text-center input-field">
                            <span class="text-gray-400 text-xs">ì„¸</span>
                        </div>
                    </td>
                    <td class="px-3 py-2">
                        <div class="relative group">
                            <input type="number" data-id="${fund.id}" data-field="amount" value="${fund.amount}" 
                                class="w-full bg-white border border-gray-200 rounded px-2 py-1 pr-12 focus:ring-2 focus:ring-blue-500 outline-none text-right font-mono input-field">
                            <span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none">ì²œì›</span>
                        </div>
                    </td>
                `;
                els.inputTableBody.appendChild(tr);
            });

            // Attach listeners to new inputs
            document.querySelectorAll('.input-field').forEach(input => {
                input.addEventListener('input', (e) => {
                    const id = Number(e.target.dataset.id);
                    const field = e.target.dataset.field;
                    let val = e.target.value;
                    if (field !== 'name') val = Number(val);

                    const fund = state.funds.find(f => f.id === id);
                    if (fund) {
                        fund[field] = val;
                        calculateAndRender();
                    }
                });
            });
        }

        // --- Calculation ---
        function calculateAndRender() {
            const minStartAge = Math.min(...state.funds.map(f => f.startAge));
            const maxEndAge = Math.max(...state.funds.map(f => f.endAge));
            const displayStartAge = Math.min(state.currentAge, minStartAge);
            const displayEndAge = Math.max(90, maxEndAge);

            const data = [];

            for (let age = displayStartAge; age <= displayEndAge; age++) {
                let row = { age, funds: [], totalNominal: 0, totalPV: 0 };

                state.funds.forEach(fund => {
                    let amount = 0;
                    if (age >= fund.startAge && age <= fund.endAge) {
                        if (fund.isInflationLinked) {
                            const years = age - fund.startAge;
                            amount = fund.amount * Math.pow(1 + PENSION_GROWTH_RATE, years);
                        } else {
                            amount = fund.amount;
                        }
                    }
                    row.funds.push(Math.round(amount));
                    row.totalNominal += amount;
                });

                const yearsFromNow = age - state.currentAge;
                const discount = Math.pow(1 + INFLATION_RATE, Math.max(0, yearsFromNow));
                row.totalPV = row.totalNominal / discount;

                row.totalNominal = Math.round(row.totalNominal);
                row.totalPV = Math.round(row.totalPV);

                if (age >= minStartAge || age >= state.currentAge) {
                    data.push(row);
                }
            }

            renderSummary(data);
            renderDetailTable(data);
            renderChart(data);
        }

        // --- Render Summary ---
        function renderSummary(data) {
            const age65 = data.find(d => d.age === 65);
            if (age65) {
                els.summaryNominal.textContent = age65.totalNominal.toLocaleString();
                els.summaryPV.textContent = age65.totalPV.toLocaleString();
            } else {
                els.summaryNominal.textContent = '-';
                els.summaryPV.textContent = '-';
            }
        }

        // --- Render Detail Table ---
        function renderDetailTable(data) {
            // Header
            let headerHTML = `<th class="px-4 py-3 text-center sticky left-0 bg-gray-100 border-r border-gray-200">ë‚˜ì´</th>`;
            state.funds.forEach(f => {
                headerHTML += `<th class="px-4 py-3 whitespace-nowrap min-w-[120px]">${f.name}</th>`;
            });
            headerHTML += `
                <th class="px-4 py-3 bg-blue-50 text-blue-900 border-l border-blue-100 min-w-[120px]">í•©ê³„ (ëª…ëª©)</th>
                <th class="px-4 py-3 bg-red-50 text-red-900 min-w-[120px]">í•©ê³„ (ì‹¤ì§ˆ)</th>
            `;
            els.detailTableHeader.innerHTML = headerHTML;

            // Body
            els.detailTableBody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";

                let rowHTML = `
                    <td class="px-4 py-2 text-center font-medium text-gray-900 sticky left-0 bg-white border-r border-gray-200 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.1)]">
                        ${row.age}ì„¸
                    </td>
                `;

                row.funds.forEach((amt, idx) => {
                    rowHTML += `
                        <td class="px-4 py-2 ${amt > 0 ? 'text-gray-700' : 'text-gray-300'}">
                            ${amt > 0 ? amt.toLocaleString() : '-'}
                        </td>
                    `;
                });

                rowHTML += `
                    <td class="px-4 py-2 font-bold text-blue-600 bg-blue-50/30 border-l border-blue-100">
                        ${row.totalNominal.toLocaleString()}
                    </td>
                    <td class="px-4 py-2 font-bold text-red-600 bg-red-50/30">
                        ${row.totalPV.toLocaleString()}
                    </td>
                `;

                tr.innerHTML = rowHTML;
                els.detailTableBody.appendChild(tr);
            });
        }

        // --- Render Chart ---
        function renderChart(data) {
            const ctx = els.canvas.getContext('2d');

            const labels = data.map(d => `${d.age}ì„¸`);
            const datasets = state.funds.map((fund, idx) => ({
                label: fund.name,
                data: data.map(d => d.funds[idx]),
                backgroundColor: FUND_COLORS[idx],
                stack: 'Stack 0',
            }));

            // Add Line dataset for PV
            datasets.push({
                type: 'line',
                label: 'í•©ê³„ (ì‹¤ì§ˆ)',
                data: data.map(d => d.totalPV),
                borderColor: '#374151',
                borderWidth: 3,
                fill: false,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 5
            });

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: {
                            stacked: true,
                            grid: { borderDash: [4, 4] },
                            ticks: { callback: v => (v / 1000).toFixed(0) + 'ë°±ë§Œ' } // Shorten large numbers if needed or just leave
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    let label = ctx.dataset.label || '';
                                    if (label) label += ': ';
                                    if (ctx.parsed.y !== null) label += ctx.parsed.y.toLocaleString() + ' ì²œì›';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Start
        window.addEventListener('DOMContentLoaded', init);

        // ë¶€ëª¨ ì°½ê³¼ì˜ í†µì‹ 
        window.addEventListener('message', function (event) {
            if (event.data === 'requestReportData') {
                const reportData = {
                    type: 'withdrawalResponse',
                    currentAge: state.currentAge,
                    funds: state.funds,
                    summaryNominal: document.getElementById('summaryNominal').textContent.trim(),
                    summaryPV: document.getElementById('summaryPV').textContent.trim()
                };
                window.parent.postMessage(reportData, '*');
            }
        });

    </script>
</body>

</html>